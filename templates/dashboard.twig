<div class="ms-auto text-end">
{% if edit %}
	<button type="button" onClick="toggleEdit()" class="btn btn-link btn-sm text-end"><i class='fas fa-edit'></i></button>
{% endif %}
	<button type="button" onClick="fullscreen()" class="btn btn-link btn-sm text-end"><i class='fas fa-expand'></i></button>
</div>
<div id="main-dashboard" class='container bg-white'>
{% if edit %}
	{{_self.editButton(false, [-1, -1])}}
{% endif %}
{% for rowIndex, row in widgetGrid %}
	<div class="row bg-light mx-auto" style="height: calc( 100% / {{widgetGrid|length}});{{ edit ? 'width: 100%' : '' }}">
	{% if edit %}
		{{_self.editButton(true, [ rowIndex, -1 ])}}
	{% endif %}
			{% for colIndex, widget in row %}
				<div class="col border d-flex flex-column-reverse align-items-center justify-content-center
				{{widget.background ? 'bg-' ~ widget.background : ''}}
				">
					{% if widget.type == 'number' %}
						{{ _self.number(widget.title, widget.value, widget.icon, widget.color) }}
					{% else %}
						{{ _self.chart(widget.type, widget.title, widget.labels, widget.series, widget.options, widget.color) }}
					{% endif %}
					{% if edit %} <button type="button" class="ms-auto btn btn-link editButton" onClick="removeWidget({{rowIndex}},{{colIndex}})"><i class="fas fa-trash-alt"></i></button> {% endif %}
				</div>
				{% if edit %} {{_self.editButton(true, [rowIndex, colIndex + 1])}} {% endif %}
			{% endfor %}
		</div>
	{% endfor %}
	{% if edit %} {{_self.editButton(false, [rowIndex + 1, -1])}} {% endif %}
</div>

{% if edit %}
<div class="modal fade" id="widgetModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
		<form action="{{addWidget_action}}" method="post" class="text-center">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
					<label for="assetSelect" class="form-label">{{"Data"|trans}}</label>
					<select name="widget" id="assetSelect" class="form-select">
					{% for key, group in data_types %}
						<optgroup label="{{key}}">
						{% for val, asset in group %}
							<option value="{{val}}">{{asset|trans}}</option>
						{% endfor %}
						</optgroup>
					{% endfor %}
					</select>
					{# <div class="btn-group mt-3" role="group" aria-label="Chart Type">
						{% set types = {
							'count': {
								'icon': 'fas fa-hashtag',
								'title': 'Count',
							}, 'line': {
								'icon': 'fas fa-chart-line',
								'title': 'Line chart',
							}, 'bar': {
								'icon': 'fa fa-chart-bar',
								'title': 'Bar chart',
							}, 'pie': {
								'icon': 'fas fa-chart-pie',
								'title': 'Pie chart',
							}
						}%}
						{% for key, type in types %}
							<input type="radio" class="btn-check" name="chartType" value="{{key}}" id="RadioFor{{type.title|slug}}Widget" {% if loop.first %}checked{% endif %}>
							<label class="btn btn-primary d-flex flex-column" for="RadioFor{{type.title|slug}}Widget">
								{{ type.title|trans }}
								<i class="{{type.icon}} d-flex flex-column" style="font-size: 2rem"></i>
							</label>
						{% endfor %}
					</div> #}
					<input type="hidden" name="id" value="{{dashboardId}}"/>
					<input type="hidden" name="coords" value="[-1, -1]"/>
					<input type="hidden" name="update" value="update"/>
			</div>
			<div class="modal-footer">
				<button type="submit" class="btn btn-primary">{{"Add widget"|trans}}</button>
			</div>
		</form>
    </div>
  </div>
</div>
<script>
	$(document).ready(function() {
		$('#widgetModal').insertAfter($('body'));
		var select_box_element = document.querySelector('#assetSelect');
		dselect(select_box_element, {
			search: true
		});
	});
	function openWidgetModal(coords) {
		$('#widgetModal input[name="coords"]').val(JSON.stringify(coords));
		$("#widgetModal").modal("show");
	}

	function toggleEdit() {
		// toggle display of all edit button
		var editButtons = document.getElementsByClassName("editButton");
		for (var i = 0; i < editButtons.length; i++) {
			editButtons[i].style.display = editButtons[i].style.display == "none" ? "block" : "none";
		}
	}

	function removeWidget(x, y) {
		$.ajax({
			url: "{{ajax_endpoint}}",
			type: "POST",
			data: {
				id: "{{dashboardId}}",
				action: "delete",
				coords: JSON.stringify([x, y]),
			},
			success: function(data) {
				location.reload();
			},
			error: function(data) {
				console.log(data);
			}
		});
	}
</script>
{% endif %}


<script>
	function fullscreen() {
		var mainDashboard = document.getElementById("main-dashboard");

		if (document.fullscreenElement || document.webkitFullscreenElement ||
			document.mozFullScreenElement || document.msFullscreenElement) {
			// If any element is in fullscreen, exit fullscreen
			exitFullscreen();
		} else {
			// Otherwise, make the main dashboard fullscreen
			requestFullscreen(mainDashboard);
		}
	}

	function requestFullscreen(element) {
		if (element.requestFullscreen) {
			element.requestFullscreen();
		} else if (element.webkitRequestFullscreen) { // Safari
			element.webkitRequestFullscreen();
		} else if (element.mozRequestFullScreen) { // Firefox
			element.mozRequestFullScreen();
		} else if (element.msRequestFullscreen) { // IE/Edge
			element.msRequestFullscreen();
		}
	}

	function exitFullscreen() {
		if (document.exitFullscreen) {
			document.exitFullscreen();
		} else if (document.webkitExitFullscreen) { // Safari
			document.webkitExitFullscreen();
		} else if (document.mozCancelFullScreen) { // Firefox
			document.mozCancelFullScreen();
		} else if (document.msExitFullscreen) { // IE/Edge
			document.msExitFullscreen();
		}
	}
</script>

{% macro number(title = '', value = 0, icon = '', color = "black") %}
	<div class="d-flex justify-content-center align-items-center">
		<i class="{{icon}} fs-1 text-{{color}}"></i>
		<div class="ms-3">
			<div class="fw-bold text-{{color}} text-wrap">{{title|raw}}</div>
			<div class="fs-3 text-${color}">{{value}}</div>
		</div>
	</div>
{% endmacro %}

{% macro chart(type = 'LineChart', title = '', labels = [], series = [], options = [], color = "black") %}
{% set rand = random() %}
	<div class="fw-bold fs-6 text-{{color}}">{{title}}</div>
	<div class="ct-chart ct-golden-section w-100" id="widgetFor{{title|slug}}_{{rand}}" {% if options.height %}style="height: {{options.height}}"{% endif %}></div>

	<script>
	$(document).ready(function() {
		var chart = new Chartist.{{type}}("#widgetFor{{title|slug}}_{{rand}}",
			{
				labels: {{labels | json_encode | raw}},
				series: {{series | json_encode | raw}},
			}, {{options | json_encode | raw}}
		);
		setTimeout(function() {
			chart.update();
		}, 500);
	});
	</script>
{% endmacro %}

{% macro editButton(isSide = true, coords = [0, 0]) %}
{% if isSide %}
	{% set class = "text-center" %}
	{% set style = "width: 2rem" %}
{% else %}
	{% set class = "row w-100 mx-auto"%}
{% endif %}
<button type="button" class="{{class}} editButton btn btn-light border p-1" style="{{style}}" onClick="openWidgetModal({{coords|json_encode}})">
	<i class="fas fa-plus mx-auto"></i>
</button>
{% endmacro %}